<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ButterBean — POS</title>

<!-- Simple styles that match HomePage color scheme (no festive extras) -->
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --accent1:#00b3ff;
    --accent2:#1ec9ff;
    --brand-border:#ff7a18;
    --page-bg:linear-gradient(180deg,#2d0b00,#3b1200);
    --panel-bg:#fffaf3;
  }
  html,body{height:100%}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--page-bg);display:flex;justify-content:center;align-items:stretch;padding:12px}
  .app{width:100%;max-width:1200px;background:var(--panel-bg);border-radius:12px;border:6px solid var(--brand-border);display:grid;grid-template-columns:1fr 420px;gap:14px;min-height:86vh;overflow:hidden}
  header{padding:12px;background:#151b22;color:#fff;display:flex;justify-content:space-between;align-items:center}
  header .title{display:flex;gap:12px;align-items:center}
  header img{height:46px}
  .left{padding:12px;display:flex;flex-direction:column;gap:10px}
  .right{padding:12px;background:#f8fbff;display:flex;flex-direction:column;gap:10px}
  .login-panel{background:#fff;border-radius:10px;padding:10px;border:1px solid #eee}
  .cat-row{display:flex;gap:8px;flex-wrap:wrap}
  .cat-btn{padding:8px 10px;border-radius:10px;border:none;background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
  .cat-btn.active{box-shadow:0 6px 18px rgba(0,0,0,.12)}
  .menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;overflow:auto;padding:6px;height:calc(86vh - 240px)}
  .menu-item{background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .item-name{font-weight:700}
  .item-desc{font-size:12px;color:#444;margin-top:6px}
  .btn{padding:8px 12px;border-radius:12px;border:none;background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
  .small-btn{padding:6px 8px;border-radius:8px}
  .cart{background:#fff;padding:10px;border-radius:10px;border:1px solid #eee;display:flex;flex-direction:column;gap:8px}
  .cart-items{overflow:auto;height:calc(86vh - 430px);padding-right:6px}
  .cart-row{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fbfeff;border-radius:8px;margin-bottom:6px}
  .controls{display:flex;gap:8px;align-items:center}
  .flex{flex:1}
  input[type=text], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
  .footer{font-size:12px;color:#666;padding-top:6px}
  .danger{background:#e53935}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:50}
  .modal .card{background:white;padding:12px;border-radius:10px;min-width:300px}
  .size-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  /* responsive */
  @media (max-width:980px){ .app{grid-template-columns:1fr} .left{order:1} .right{order:2} .menu-grid{height:48vh} .cart-items{height:24vh} }
</style>
</head>
<body>

<div class="app">

  <!-- LEFT: Menu / Categories -->
  <div class="left">
    <header>
      <div class="title">
        <img src="icons/logo.png" alt="ButterBean">
        <div>
          <div style="font-weight:800">ButterBean — POS</div>
          <div style="font-size:13px;color:#fff;opacity:.9">Quick till for in-store sales</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div id="currentRole" style="font-size:13px;color:#fff">Not signed in</div>
        <button class="btn" id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <!-- login -->
    <div class="login-panel" id="loginPanel">
      <label><strong>Sign in (Manager / Staff)</strong></label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="pinInput" type="password" placeholder="Enter PIN">
        <button class="btn" onclick="doLogin()">Sign in</button>
      </div>
      <div style="margin-top:8px;font-size:13px;color:#333">Managers can access Reports & generate loyalty codes.</div>
    </div>

    <!-- main POS area -->
    <div id="mainArea" style="display:none">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div style="flex:1">
          <div class="cat-row" id="categories"></div>
        </div>
        <div style="width:220px;display:flex;gap:8px;flex-direction:column">
          <button class="btn" onclick="setWalkIn()">Walk-in</button>
          <button class="btn" onclick="setCasual()">Casual</button>
          <div style="display:flex;gap:6px">
            <input id="quickSearch" placeholder="Search menu..." oninput="renderMenu()" />
            <button class="btn" onclick="renderMenu()">Go</button>
          </div>
        </div>
      </div>

      <div class="menu-grid" id="menuGrid"></div>
    </div>
  </div>

  <!-- RIGHT: Cart, loyalty, payments -->
  <div class="right">
    <div class="cart">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Cart</strong> <span id="cartCount" style="font-size:13px;color:#666">(0 items)</span></div>
        <div style="font-size:13px;color:#666">Till: <span id="tillUser">—</span></div>
      </div>

      <div class="cart-items" id="cartItems">Cart is empty</div>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label class="small">Custom item name</label>
          <input id="customName" type="text" placeholder="e.g. Muffin">
        </div>
        <div style="width:110px">
          <label class="small">Price (R)</label>
          <input id="customPrice" type="number" placeholder="25">
        </div>
        <div style="width:100px;display:flex;align-items:end">
          <button class="btn" onclick="addCustom()">Add</button>
        </div>
      </div>

      <div style="margin-top:6px">
        <label class="small">Discount</label>
        <div style="display:flex;gap:6px;margin-top:6px">
          <input id="discountValue" placeholder="10 or 10%" />
          <select id="discountType">
            <option value="fixed">R (fixed)</option>
            <option value="percent">Percent (%)</option>
          </select>
          <button class="btn" onclick="applyDiscount()">Apply</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <div style="flex:1">
          <label class="small">Payment</label>
          <select id="paymentType">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="snapscan">SnapScan</option>
            <option value="yoco">Yoco</option>
            <option value="account">Account</option>
          </select>
        </div>
        <div style="width:120px">
          <label class="small">Paid</label>
          <input id="amountPaid" type="number" placeholder="0">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn flex" onclick="finishSale()">Finish Sale & Save</button>
        <button class="btn" onclick="openLoyalty()">Loyalty</button>
      </div>

      <div style="margin-top:6px;display:flex;gap:8px">
        <button class="btn" onclick="quickExactCash()">Exact Cash + Print</button>
        <button class="btn danger" onclick="clearCart()">Clear</button>
      </div>

      <div class="footer">
        Saved orders go to Firestore `orders` collection and will show in Staff Console / Manager Dashboard.
      </div>
    </div>

    <!-- Loyalty & Reports -->
    <div style="background:#fff;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:8px">
      <div id="loyaltyPanel">
        <strong>Loyalty</strong>
        <div style="margin-top:6px;display:flex;gap:6px">
          <input id="loyaltyPhone" placeholder="Phone (2773...)" />
          <button class="btn" onclick="loadLoyalty()">Lookup</button>
        </div>
        <div id="loyaltyInfo" style="margin-top:6px"></div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="btn" onclick="addStampFromPos()">+ Add Stamp</button>
          <button class="btn" onclick="resetStamps()">Reset</button>
          <button class="btn" onclick="generateStampCode()">Generate Code</button>
        </div>
      </div>

      <div id="reportsPanel" style="display:none;margin-top:8px">
        <strong>Reports (Managers)</strong>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="btn" onclick="loadTodayStats()">Load Today</button>
          <button class="btn" onclick="exportCSV()">Export CSV</button>
        </div>
        <pre id="reportsArea" style="margin-top:6px;font-size:12px;color:#444"></pre>
      </div>
    </div>
  </div>
</div>

<!-- SIZE PICKER MODAL -->
<div id="sizeModal" class="modal">
  <div class="card">
    <div style="font-weight:800" id="sizeModalTitle">Choose size</div>
    <div id="sizeOptions" class="size-grid"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button class="btn" onclick="closeSizeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE CONFIG (same as your other pages) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAG_RsdqHCslRR-xW2-3GrEKXn-UYAECYY",
  authDomain: "butterbean-3869c.firebaseapp.com",
  projectId: "butterbean-3869c",
  storageBucket: "butterbean-3869c.firebasestorage.app",
  messagingSenderId: "329727412036",
  appId: "1:329727412036:web:7e41bebb8094fb70847911"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
/* ===================================================== */

/* ===== PINS (editable here) ===== */
const PINS = {
  managers: { "7788": "Manager A", "9922": "Manager B" },
  staff:    { "1942": "Staff A",   "5511": "Staff B" }
};

let currentUser = null;

/* ===== MENU DATA (built from your images) =====
   Option B chosen: single item button, modal to choose sizes/variants
*/
const MENU = {
  "Classic Pizzas": [
    { n:"Margherita", variants:[ {label:"20cm",p:35},{label:"30cm",p:70} ] },
    { n:"Butterbean Chicken", variants:[ {label:"20cm",p:40},{label:"30cm",p:80} ] },
    { n:"Butterbean Bacon", variants:[ {label:"20cm",p:40},{label:"30cm",p:80} ] },
    { n:"Butterbean Pepperoni", variants:[ {label:"20cm",p:45},{label:"30cm",p:85} ] },
    { n:"Regina", variants:[ {label:"20cm",p:45},{label:"30cm",p:90} ] },
    { n:"Hawaiian", variants:[ {label:"20cm",p:45},{label:"30cm",p:90} ] },
    { n:"Four Seasons", variants:[ {label:"20cm",p:45},{label:"30cm",p:90} ] },
    { n:"BBQ Chicken", variants:[ {label:"20cm",p:50},{label:"30cm",p:95} ] },
    { n:"BBQ Rib", variants:[ {label:"20cm",p:50},{label:"30cm",p:100} ] }
  ],
  "Deluxe Pizzas": [
    { n:"Meat Lover", variants:[ {label:"20cm",p:60},{label:"30cm",p:125} ] },
    { n:"Supreme", variants:[ {label:"20cm",p:60},{label:"30cm",p:115} ] },
    { n:"Mafia", variants:[ {label:"20cm",p:60},{label:"30cm",p:115} ] },
    { n:"The Ranch", variants:[ {label:"20cm",p:60},{label:"30cm",p:115} ] },
    { n:"Herbivore", variants:[ {label:"20cm",p:65},{label:"30cm",p:130} ] },
    { n:"Carnivore", variants:[ {label:"20cm",p:70},{label:"30cm",p:145} ] },
    { n:"Omnivore", variants:[ {label:"20cm",p:75},{label:"30cm",p:175} ] }
  ],
  "Burgers": [
    { n:"Average Joe", p:70 },
    { n:"Average Jane", p:70 },
    { n:"The Big Cheese", p:75 },
    { n:"The Porky", p:80 },
    { n:"The Butcher", p:120 },
    { n:"The Trident", p:80 },
    { n:"Magic Mushroom", p:75 }
  ],
  "Toasted": [
    { n:"Cheese", p:15 },
    { n:"Cheese & Tomato", p:20 },
    { n:"Ham & Cheese", p:30 },
    { n:"Ham, Cheese & Tomato", p:35 },
    { n:"Bacon & Cheese", p:30 },
    { n:"Bacon, Egg & Cheese", p:35 },
    { n:"Chicken Mayo", p:35 }
  ],
  "Meals": [
    { n:"Ribs & Chips", p:120 },
    { n:"Buffalo Wings & Chips", p:75 },
    { n:"Chicken Strips & Chips", p:65 },
    { n:"Battered Hake & Chips", p:75 },
    { n:"Chicken Schnitzel", p:80 },
    { n:"Boerewors & Chips", p:75 }
  ],
  "Chips & Russian": [
    { n:"Medium Chips", p:25 },
    { n:"Large Chips", p:50 },
    { n:"Russian (Buget)", p:10 },
    { n:"Russian (Regular)", p:15 }
  ],
  "Coffee": [
    { n:"Americano M", p:20 }, { n:"Americano L", p:30 },
    { n:"Cappuccino M", p:25 }, { n:"Cappuccino L", p:35 },
    { n:"Latte M", p:25 }, { n:"Latte L", p:35 },
    { n:"Frappe M", p:25 }, { n:"Frappe L", p:35 },
    { n:"Flat White M", p:25 }, { n:"Flat White L", p:35 },
    { n:"Mocacino M", p:30 }, { n:"Mocacino L", p:40 }
  ],
  "Shakes": [
    { n:"Chocolate Shake M", p:25 }, { n:"Chocolate Shake L", p:35 },
    { n:"Strawberry Shake M", p:25 }, { n:"Strawberry Shake L", p:35 },
    { n:"Banana Shake M", p:25 }, { n:"Banana Shake L", p:35 },
    { n:"Bubblegum Shake M", p:25 }, { n:"Bubblegum Shake L", p:35 },
    { n:"Cookies & Cream M", p:25 }, { n:"Cookies & Cream L", p:35 },
    { n:"Salted Caramel M", p:25 }, { n:"Salted Caramel L", p:35 },
    { n:"Rum & Raisin M", p:25 }, { n:"Rum & Raisin L", p:35 }
  ],
  "Cold Drinks": [
    { n:"Coke", p:15 }, { n:"Fanta", p:15 }, { n:"Sprite", p:15 },
    { n:"Powerade", p:15 }, { n:"Stoney", p:15 }, { n:"Water", p:15 }
  ],
  "Extras": [
    { n:"Pepperoni", p:20 }, { n:"Mozzarella/Cheddar", p:20 }, { n:"Mushrooms", p:15 },
    { n:"Bacon", p:20 }, { n:"Pineapple", p:15 }, { n:"BBQ Chicken", p:20 },
    { n:"BBQ Rib", p:20 }, { n:"Ham", p:20 }, { n:"Garlic", p:10 }, { n:"Olives", p:15 },
    { n:"Onions", p:10 }, { n:"Peppers", p:10 }
  ]
};

/* ===== cart state & UI refs ===== */
let cart = [];
let currentCategory = Object.keys(MENU)[0];
let discount = { type:null, value:0 };

const categoriesEl = document.getElementById("categories");
const menuGrid = document.getElementById("menuGrid");
const cartItemsEl = document.getElementById("cartItems");
const cartCountEl = document.getElementById("cartCount");
const currentRoleEl = document.getElementById("currentRole");
const tillUserEl = document.getElementById("tillUser");
const loginPanel = document.getElementById("loginPanel");
const mainArea = document.getElementById("mainArea");
const logoutBtn = document.getElementById("logoutBtn");
const reportsPanel = document.getElementById("reportsPanel");

/* ===== render categories & menu ===== */
function renderCategories(){
  categoriesEl.innerHTML = "";
  Object.keys(MENU).forEach(cat=>{
    const b = document.createElement("button");
    b.className = "cat-btn" + (cat===currentCategory? " active":"");
    b.innerText = cat;
    b.onclick = ()=>{ currentCategory=cat; renderCategories(); renderMenu(); };
    categoriesEl.appendChild(b);
  });
}
function renderMenu(){
  const q = (document.getElementById("quickSearch").value||"").toLowerCase();
  menuGrid.innerHTML = "";
  (MENU[currentCategory] || []).forEach(it=>{
    if(q && !(it.n.toLowerCase().includes(q))) return;
    const d = document.createElement("div");
    d.className = "menu-item";
    const left = document.createElement("div");
    left.style.maxWidth="70%";
    left.innerHTML = `<div class="item-name">${it.n}</div>
                      ${it.desc? `<div class="item-desc">${it.desc}</div>` : ""}`;
    const right = document.createElement("div");
    const addBtn = document.createElement("button");
    addBtn.className = "btn";
    addBtn.innerText = "Add";
    // attach listener safely
    addBtn.onclick = ()=> onItemAdd(it);
    right.appendChild(addBtn);
    d.appendChild(left);
    d.appendChild(right);
    menuGrid.appendChild(d);
  });
}

/* ===== handle add item (option B: size chooser) ===== */
let sizeModalResolve = null;
function onItemAdd(item){
  // if item has variants array -> show size modal
  if(item.variants && item.variants.length>0){
    openSizeModal(item);
    return;
  }
  // else item has single price
  addToCart({ n:item.n, p:item.p, qty:1 });
}

function openSizeModal(item){
  const modal = document.getElementById("sizeModal");
  document.getElementById("sizeModalTitle").innerText = item.n;
  const opts = document.getElementById("sizeOptions");
  opts.innerHTML = "";
  item.variants.forEach(v=>{
    const b = document.createElement("button");
    b.className = "btn small-btn";
    b.innerText = `${v.label} — R${v.p}`;
    b.onclick = ()=> { closeSizeModal(); addToCart({ n: item.n + " " + v.label, p: v.p, qty:1}); };
    opts.appendChild(b);
  });
  modal.style.display = "flex";
}
function closeSizeModal(){ document.getElementById("sizeModal").style.display = "none"; }

/* ===== add to cart / custom items ===== */
function addToCart(it){
  // merge with similar item (same name & price)
  const existingIndex = cart.findIndex(c => c.n === it.n && c.p === it.p && !c.custom);
  if(existingIndex !== -1){
    cart[existingIndex].qty += (it.qty||1);
  } else {
    cart.push({...it, qty: it.qty||1});
  }
  renderCart();
}
function addCustom(){
  const name = document.getElementById("customName").value.trim();
  const price = Number(document.getElementById("customPrice").value);
  if(!name || !price){ alert("Enter custom name & price"); return; }
  addToCart({ n:name, p:price, qty:1, custom:true });
  document.getElementById("customName").value = "";
  document.getElementById("customPrice").value = "";
}

/* ===== cart UI ===== */
function renderCart(){
  cartItemsEl.innerHTML = "";
  if(cart.length===0){ cartItemsEl.innerText = "Cart is empty"; cartCountEl.innerText="(0 items)"; return; }
  let subtotal = 0, items=0;
  cart.forEach((c, i)=>{
    subtotal += c.p * c.qty;
    items += c.qty;
    const r = document.createElement("div");
    r.className = "cart-row";
    r.innerHTML = `<div>
      <div style="font-weight:700">${c.n}</div>
      <div style="font-size:12px;color:#555">R${c.p} × ${c.qty}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <div>
        <button class="btn small-btn" onclick="changeQty(${i},1)">+1</button>
        <button class="btn small-btn" onclick="changeQty(${i},-1)">-1</button>
        <button class="btn small-btn danger" onclick="removeItem(${i})">Remove</button>
      </div>
      <div style="font-weight:800">R${(c.p*c.qty).toFixed(2)}</div>
    </div>`;
    cartItemsEl.appendChild(r);
  });
  // discount
  let discAmount = 0;
  if(discount.type === "fixed") discAmount = Number(discount.value);
  if(discount.type === "percent") discAmount = subtotal * (Number(discount.value)/100);
  const final = Math.max(0, subtotal - discAmount);
  const summary = document.createElement("div");
  summary.innerHTML = `<div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>R${subtotal.toFixed(2)}</div></div>
    <div style="display:flex;justify-content:space-between"><div>Discount</div><div>R${discAmount.toFixed(2)}</div></div>
    <hr style="border:none;border-top:1px solid #eee;margin:8px 0">
    <div style="display:flex;justify-content:space-between;font-weight:800"><div>Total</div><div>R${final.toFixed(2)}</div></div>`;
  cartItemsEl.appendChild(summary);
  cartCountEl.innerText = `(${items} items)`;
}
function changeQty(i, delta){ cart[i].qty += delta; if(cart[i].qty<=0) cart.splice(i,1); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; discount={type:null,value:0}; renderCart(); }

/* ===== discount ===== */
function applyDiscount(){
  const val = document.getElementById("discountValue").value;
  const type = document.getElementById("discountType").value;
  if(!val){ alert("Enter a discount value"); return; }
  discount = { type, value: Number(val) };
  renderCart();
}

/* ===== walk-in quick flows ===== */
function setWalkIn(){ document.getElementById("amountPaid").value = ""; alert("Walk-in set. Add items and finish sale."); }
function setCasual(){ document.getElementById("amountPaid").value = ""; alert("Casual quick sale. Use Quick Exact Cash to finish fast."); }

/* ===== loyalty functions (same structure as earlier) ===== */
async function loadLoyalty(){
  const phone = (document.getElementById("loyaltyPhone").value||"").trim();
  if(!phone){ alert("Enter phone"); return; }
  const ref = db.collection("loyalty_cards").doc(phone);
  const snap = await ref.get();
  if(!snap.exists){ document.getElementById("loyaltyInfo").innerHTML = `No card for ${phone}. <button class="btn" onclick="createLoyalty('${phone}')">Create</button>`; return; }
  const data = snap.data();
  document.getElementById("loyaltyInfo").innerHTML = `<div><strong>${data.name||"No name"}</strong></div><div class="small">Stamps: <span id="stampCount">${data.stamps||0}</span>/9</div>`;
}
async function createLoyalty(phone){ const name = prompt("Full name:"); if(!name) return; await db.collection("loyalty_cards").doc(phone).set({name,phone,stamps:0,updated:firebase.firestore.FieldValue.serverTimestamp()}); loadLoyalty(); }
async function addStampFromPos(){ const phone = (document.getElementById("loyaltyPhone").value||"").trim(); if(!phone) return alert("Lookup phone first"); const ref = db.collection("loyalty_cards").doc(phone); try{ await db.runTransaction(async tx=>{ const s = (await tx.get(ref)).data().stamps||0; tx.update(ref,{stamps:s+1,updated:firebase.firestore.FieldValue.serverTimestamp()}); }); alert("Stamp added"); loadLoyalty(); }catch(e){ alert("Failed: "+e); } }
async function resetStamps(){ const phone = (document.getElementById("loyaltyPhone").value||"").trim(); if(!phone) return alert("Lookup phone first"); if(!confirm("Reset stamps?")) return; await db.collection("loyalty_cards").doc(phone).update({stamps:0,updated:firebase.firestore.FieldValue.serverTimestamp()}); loadLoyalty(); }
async function generateStampCode(){ if(!currentUser || currentUser.role!=="manager") return alert("Managers only"); const code = Math.floor(100000 + Math.random()*900000).toString(); await db.collection("stamp_codes").add({code,used:false,created:firebase.firestore.FieldValue.serverTimestamp(),createdBy:currentUser.name}); alert("Generated: "+code); }

/* ===== finish sale (save to firestore) ===== */
async function finishSale(){
  if(cart.length===0) return alert("Cart is empty");
  const customerName = prompt("Customer name (optional):","Walk-in") || "Walk-in";
  const customerPhone = prompt("Phone (optional):","") || "";
  const payment = document.getElementById("paymentType").value;
  // totals
  let subtotal = 0;
  cart.forEach(c=> subtotal += c.p * c.qty );
  let discAmount = 0;
  if(discount.type==="fixed") discAmount = Number(discount.value);
  if(discount.type==="percent") discAmount = subtotal * (Number(discount.value)/100);
  const total = Math.max(0, subtotal - discAmount);

  const payload = {
    customerName,
    phone: customerPhone,
    items: cart,
    subtotal, discount, total,
    payment, source: "pos",
    status: "received",
    created: firebase.firestore.FieldValue.serverTimestamp(),
    createdBy: currentUser ? currentUser.name : "pos"
  };

  try{
    const docRef = await db.collection("orders").add(payload);
    alert("Saved order: " + docRef.id);
    printReceipt(docRef.id, payload);
    clearCart();
  }catch(e){ alert("Save failed: "+e); console.error(e); }
}

/* quick exact cash finish (assumes paid exact and prints) */
function quickExactCash(){
  if(cart.length===0) return alert("Cart empty");
  // set amountPaid to total for UX
  const subtotal = cart.reduce((s,c)=>s + c.p*c.qty,0);
  let discAmount = 0;
  if(discount.type==="fixed") discAmount = Number(discount.value);
  if(discount.type==="percent") discAmount = subtotal * (Number(discount.value)/100);
  const total = Math.max(0, subtotal - discAmount);
  document.getElementById("amountPaid").value = total;
  // set payment to cash
  document.getElementById("paymentType").value = "cash";
  // short confirm
  if(confirm("Finish sale and print receipt?")){
    finishSale();
  }
}

/* ===== printable receipt ===== */
function printReceipt(id,payload){
  const w = window.open("about:blank","_blank","width=420,height=600");
  const d = w.document;
  d.write(`<html><head><title>Receipt</title><style>body{font-family:Arial;padding:12px} .row{display:flex;justify-content:space-between;margin-bottom:6px} .total{font-weight:800;margin-top:10px}</style></head><body>`);
  d.write(`<div style="text-align:center"><h2>ButterBean</h2><div>Order: ${id}</div><div>${new Date().toLocaleString()}</div></div>`);
  d.write(`<div style="margin-top:12px"><strong>Served by:</strong> ${payload.createdBy}</div>`);
  d.write(`<div style="margin-top:8px">`);
  payload.items.forEach(it=>{
    d.write(`<div class="row"><div>${it.n} x${it.qty}</div><div>R${(it.p*it.qty).toFixed(2)}</div></div>`);
  });
  d.write(`</div>`);
  d.write(`<div class="total">TOTAL: R${payload.total.toFixed(2)}</div>`);
  if(payload.payment) d.write(`<div>Payment: ${payload.payment}</div>`);
  if(payload.customerName) d.write(`<div>Customer: ${payload.customerName}</div>`);
  d.write(`<div style="margin-top:12px;font-size:12px;color:#666">Thank you for supporting ButterBean</div>`);
  d.write(`</body></html>`);
  d.close();
  setTimeout(()=> { w.print(); }, 600);
}

/* ===== simple reports (managers) ===== */
async function loadTodayStats(){
  const start = new Date(); start.setHours(0,0,0,0);
  const snap = await db.collection("orders").where("created", ">=", firebase.firestore.Timestamp.fromDate(start)).get();
  let revenue = 0, orders = snap.size;
  const itemsCount = {};
  snap.forEach(d=>{
    const data = d.data();
    revenue += Number(data.total) || 0;
    (data.items||[]).forEach(i=> itemsCount[i.n] = (itemsCount[i.n]||0) + (i.qty||1));
  });
  document.getElementById("reportsArea").innerText = `Orders: ${orders}\nRevenue: R${revenue.toFixed(2)}\nTop: ${Object.entries(itemsCount).sort((a,b)=>b[1]-a[1]).slice(0,7).map(x=>x[0]).join(", ")}`;
}
async function exportCSV(){
  const start = new Date(); start.setHours(0,0,0,0);
  const snap = await db.collection("orders").where("created", ">=", firebase.firestore.Timestamp.fromDate(start)).get();
  const rows = [["id","created","customer","phone","total","payment","source"]];
  snap.forEach(d=>{
    const data = d.data();
    rows.push([d.id, data.created?.toDate?.().toISOString()||"", data.customerName||"", data.phone||"", data.total||0, data.payment||"", data.source||""]);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download="butterbean_today.csv"; a.click(); URL.revokeObjectURL(url);
}

/* ===== login flow ===== */
function doLogin(){
  const pin = (document.getElementById("pinInput").value||"").trim();
  if(PINS.managers[pin]) currentUser = { role:"manager", pin, name:PINS.managers[pin] };
  else if(PINS.staff[pin]) currentUser = { role:"staff", pin, name:PINS.staff[pin] };
  else { alert("Wrong PIN"); return; }

  currentRoleEl.innerText = `${currentUser.role.toUpperCase()} — ${currentUser.name}`;
  tillUserEl.innerText = currentUser.name;
  loginPanel.style.display = "none";
  mainArea.style.display = "block";
  logoutBtn.style.display = "inline-block";
  logoutBtn.onclick = doLogout;
  document.getElementById("pinInput").value = "";
  if(currentUser.role === "manager"){ reportsPanel.style.display = "block"; document.getElementById("reportsPanel").style.display = "block"; } else { reportsPanel.style.display = "none"; document.getElementById("reportsPanel").style.display = "none"; }
  renderCategories(); renderMenu();
}
function doLogout(){ currentUser = null; currentRoleEl.innerText="Not signed in"; tillUserEl.innerText="—"; loginPanel.style.display="block"; mainArea.style.display="none"; logoutBtn.style.display="none"; clearCart(); }

/* ===== boot ===== */
renderCategories();
renderMenu();
renderCart();

</script>
</body>
</html>
